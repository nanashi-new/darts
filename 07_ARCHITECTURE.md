# 07 — Архитектура приложения

Связанные документы:
- Требования: [01_REQUIREMENTS.md](01_REQUIREMENTS.md)
- Правила: [02_RULES_ALGORITHMS.md](02_RULES_ALGORITHMS.md)
- Модель БД: [03_DATA_MODEL_DB.md](03_DATA_MODEL_DB.md)
- Технологии: [06_TECH_STACK.md](06_TECH_STACK.md)
- Бэклог: [08_BACKLOG.md](08_BACKLOG.md)

---

## 1. Архитектурные принципы

- чёткое разделение ответственности;
- UI **не содержит бизнес-логики**;
- все расчёты изолированы в domain;
- импорт/экспорт — отдельные сервисы;
- возможность полного пересчёта рейтинга.

---

## 2. Слои приложения

### 2.1 UI (Presentation Layer)
- PySide6 (Qt);
- окна, вкладки, таблицы;
- не знает формул и SQL.

**Примеры:**
- `ui/rating_view.py`
- `ui/tournament_view.py`
- `ui/player_view.py`

---

### 2.2 Application / Services Layer
- сценарии использования;
- связывает UI, domain и БД.

**Примеры:**
- `services/import_xlsx.py`
- `services/export_pdf.py`
- `services/recalculate_rating.py`

---

### 2.3 Domain Layer
**Самый важный слой** — логика EBCK.

Содержит:
- расчёт разрядов;
- начисление очков;
- rolling-рейтинг;
- сортировку и тай-брейки.

**Примеры:**
- `domain/ranks.py`
- `domain/points.py`
- `domain/rating.py`

Этот слой:
- не знает про UI;
- не знает про Excel;
- легко тестируется.

---

### 2.4 Data Layer
- SQLite;
- доступ через репозитории;
- минимальный SQL в одном месте.

**Примеры:**
- `db/models.py`
- `db/repositories.py`

---

## 3. Потоки данных (ключевые)

### 3.1 Импорт турнира из Excel

1. UI → выбор файла
2. `ImportService`:
   - распознаёт таблицы
   - валидирует данные
3. UI → предпросмотр
4. Пользователь подтверждает
5. Данные сохраняются в БД
6. Запуск пересчёта рейтинга
7. UI обновляется

---

### 3.2 Пересчёт рейтинга

1. Получить игроков категории
2. Получить последние N турниров
3. Сложить очки
4. Отсортировать
5. Сохранить кэш (опц.)
6. Вернуть результат в UI

---

### 3.3 Экспорт рейтинга

1. UI → выбранная категория
2. `ExportService`:
   - формирует таблицу
3. Экспорт:
   - PDF
   - Excel
   - изображение

---

## 4. Обработка ошибок

- ошибки импорта не падают приложением;
- показываются пользователю списком;
- возможен частичный импорт.

---

## 5. Расширяемость

Архитектура позволяет:
- добавить новые дисциплины;
- изменить правила без правки UI;
- добавить веб-версию в будущем;
- расширять отчёты.

---

## 6. Рекомендации для Codex

- генерировать код **по слоям**;
- начинать с domain;
- писать тесты для domain;
- UI подключать в конце.

---

Конец документа.
