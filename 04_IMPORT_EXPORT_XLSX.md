# 04 — Импорт и экспорт Excel (XLSX)

Связанные документы:
- Требования: [01_REQUIREMENTS.md](01_REQUIREMENTS.md)
- Алгоритмы: [02_RULES_ALGORITHMS.md](02_RULES_ALGORITHMS.md)
- Модель БД: [03_DATA_MODEL_DB.md](03_DATA_MODEL_DB.md)
- UI / UX: [05_UI_UX_FLOW.md](05_UI_UX_FLOW.md)
- Тест-план: [09_TEST_PLAN.md](09_TEST_PLAN.md)

---

## 1. Общая цель

Импорт из Excel должен:
- работать **быстро и стабильно**;
- не требовать ручной подготовки файлов;
- уметь обрабатывать реальные «кривые» протоколы;
- быть понятным судье без IT-навыков.

Экспорт должен:
- полностью соответствовать отображаемым таблицам;
- быть пригодным для печати и передачи.

---

## 2. Поддерживаемые сценарии импорта

### 2.1 Один файл — одна таблица
Пример:
- один лист
- одна таблица результатов
- стандартный заголовок

### 2.2 Один файл — несколько таблиц подряд
Пример:
- несколько возрастных категорий
- таблицы разделены пустыми строками
- каждая таблица = отдельная категория / турнир

Приложение должно:
- автоматически находить границы таблиц;
- позволять пользователю подтвердить найденные блоки.

---

### 2.3 Импорт папки (batch)
- пользователь выбирает папку;
- приложение находит все `.xlsx`;
- файлы импортируются по очереди;
- показывается прогресс и список ошибок;
- пользователь может пропустить проблемные файлы.

---

## 3. Автоматическое распознавание таблицы

### 3.1 Поиск заголовков колонок

Программа должна искать колонки по **синонимам**.

Пример словаря:

| Назначение | Возможные названия |
|---------|------------------|
| ФИО | ФИО, Игрок, Фамилия Имя |
| Дата рождения | ДР, Год рождения |
| Набор очков | Набор, Очки |
| Сектор 20 | С20, Sector 20 |
| Большой раунд | БР, Big Round |
| Место | Место, Place |

Регистр и пробелы игнорируются.

---

### 3.2 Определение границ таблицы
Таблица считается законченной, если:
- встречается пустая строка;
- встречается строка «Итого»;
- следующая строка содержит новый заголовок.

---

## 4. Мастер сопоставления колонок

Если авто-распознавание не уверено:

1. Показать предпросмотр таблицы.
2. Пользователь вручную выбирает:
   - где ФИО
   - где дисциплины
   - где место
3. Сохранить профиль сопоставления.
4. При следующем импорте использовать его автоматически.

---

## 5. Идентификация игроков

### 5.1 Основное правило
Игрок ищется по:
- ФИО
- + дате рождения (или году рождения)

### 5.2 Если игрок не найден
- предлагается создать нового.

### 5.3 Если найдено несколько кандидатов
(v1.1)
- показать список;
- предложить выбрать или объединить.

---

## 6. Валидация данных

Перед сохранением:
- проверка пустых ФИО;
- проверка корректности чисел;
- проверка мест (>=1);
- предупреждения, а не аварийные ошибки.

Ошибки импорта **не должны ломать всё**.

---

## 7. Сохранение источника

Для каждого турнира сохраняется:
- список импортированных файлов;
- дата импорта;
- профиль импорта.

Это нужно для:
- аудита;
- повторного импорта;
- отладки.

---

## 8. Экспорт в Excel

### 8.1 Что можно экспортировать
- рейтинг выбранной категории;
- рейтинг всех категорий;
- протокол турнира;
- история игрока.

### 8.2 Требования
- один файл = один отчёт;
- понятные заголовки;
- автоширина колонок;
- готово к печати.

---

## 9. Экспорт как изображение

- таблица рейтинга может быть сохранена как PNG/JPG;
- используется для отправки в мессенджеры;
- визуально соответствует экрану.

---

## 10. Техническая реализация

Рекомендуется:
- `openpyxl` — чтение/запись `.xlsx`;
- для batch-импорта — отдельный сервис;
- все импорты проходят через единый пайплайн.

---

Конец документа.
